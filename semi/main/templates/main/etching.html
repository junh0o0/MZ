{% load static %}

<style>
  body, html {
    height: 100%;
    margin: 0;
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    background: url("{% static 'img/lab_back.png' %}") no-repeat center calc(100% + 50px) fixed;
    background-size: 110% auto;
    background-color: white;
  }

  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    width: 100%;
    height: 100%;
    padding-bottom: 20px;
  }

  .content-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 30px;
    margin-bottom: 30px;
    z-index: 1;
  }

  .students-image {
    width: 240px;
    height: 330px;
    transform: scaleX(-1);
  }

  .mol-container {
    width: 600px;
    height: 600px;
    border: none;
    position: relative;
    background-color: transparent;
  }

  .mol-container canvas {
    background-color: transparent !important;
  }

  #viewer {
    background: none !important;
  }

  .chat-box {
    width: 1600px;
    height: 400px;
    border: 1px solid #aaa;
    border-radius: 10px;
    padding: 15px;
    background-color: rgba(249, 249, 249, 0.95);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    z-index: 1;
  }

  .chat-log {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 10px;
    font-size: 14px;
  }

  .chat-input-area {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .chat-input-area input {
    flex: 1;
    padding: 8px;
    font-size: 14px;
  }

  .chat-input-area button {
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
  }

  .controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
  }

  .controls button {
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
  }

  .exit-button {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #ff4d4d;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.3s;
  }

  .exit-button:hover {
    background-color: #d93a3a;
  }

  .students {
    position: fixed;
    left: 50px;
    bottom: 50px;
    width: 160px;
    height: 220px;
  }
</style>

<div class="container">
  <button class="exit-button" onclick="window.location.href='/'">üè† Ï≤òÏùåÏúºÎ°ú</button>
  
  <div class="content-wrapper">
    <img src="{% static 'img/students.png' %}" alt="ÌïôÏÉùÎì§" class="students-image">
    <div class="mol-container" id="viewer"></div>
  </div>

  <div class="chat-box">
    <div class="chat-log" id="chatLog">
      <div><strong>GPT:</strong> Í∂ÅÍ∏àÌïú Ï†êÏùÑ ÏûÖÎ†•Ìï¥Î≥¥ÏÑ∏Ïöî!</div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="userInput" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." />
      <button onclick="sendMessage()">Send</button>
    </div>
    <div class="controls">
      <button onclick="viewer.animate({ interval: 100 })">‚ñ∂ Ïû¨ÏÉù</button>
      <button onclick="viewer.stopAnimate()">‚è∏ Ï†ïÏßÄ</button>
    </div>
  </div>
</div>

<script src="https://3Dmol.org/build/3Dmol-min.js"></script>

<script>
let viewer;

fetch("{% static 'traj/oxidation_final.xyz' %}")
  .then(res => res.text())
  .then(data => {
    viewer = $3Dmol.createViewer("viewer", { 
      backgroundColor: "transparent",
      alpha: true,
      antialias: true,
      preserveDrawingBuffer: true
    });
    viewer.addModelsAsFrames(data, "xyz");
    viewer.setStyle({}, { 
      sphere: {
        opacity: 0.9
      } 
    });
    viewer.zoomTo();
    viewer.render();
    viewer.animate({ interval: 100 });
  });

// CSRF ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function sendMessage() {
  const input = document.getElementById('userInput');
  const chatLog = document.getElementById('chatLog');
  const userMessage = input.value.trim();

  if (!userMessage) return;

  // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ ÌëúÏãú
  chatLog.innerHTML += `<div><strong>ÎÇò:</strong> ${userMessage}</div>`;
  chatLog.scrollTop = chatLog.scrollHeight;

  // Î°úÎî© Î©îÏãúÏßÄ
  const loading = document.createElement('div');
  loading.innerHTML = `<strong>GPT:</strong> ...ÎãµÎ≥ÄÏùÑ ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...`;
  chatLog.appendChild(loading);
  chatLog.scrollTop = chatLog.scrollHeight;

  // ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠
  fetch("/ai_chat/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ message: userMessage })
  })
  .then(res => res.json())
  .then(data => {
    loading.innerHTML = `<strong>GPT:</strong> ${data.reply}`;
    chatLog.scrollTop = chatLog.scrollHeight;
  });

  input.value = '';
}
</script>