{% load static %}

<style>
  body, html {
    height: 100%;
    margin: 0;
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .mol-container {
    width: 600px;
    height: 600px;
    border: 1px solid #ccc;
    position: relative;
    margin-bottom: 30px;
  }

  .chat-box {
    width: 1600px;
    height: 400px;
    border: 1px solid #aaa;
    border-radius: 10px;
    padding: 15px;
    background-color: #f9f9f9;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }

  .chat-log {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 10px;
    font-size: 14px;
  }

  .chat-input-area {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .chat-input-area input {
    flex: 1;
    padding: 8px;
    font-size: 14px;
  }

  .chat-input-area button {
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
  }

  .controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
  }

  .controls button {
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
  }

  .exit-button {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #ff4d4d;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.3s;
  }

  .exit-button:hover {
    background-color: #d93a3a;
  }
</style>

<div class="container">
  <!-- ë‚˜ê°€ê¸° ë²„íŠ¼ -->
  <button class="exit-button" onclick="window.location.href='/'">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>

  <div class="mol-container" id="viewer"></div>

  <div class="chat-box">
    <div class="chat-log" id="chatLog">
      <div><strong>GPT:</strong> ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•´ë³´ì„¸ìš”!</div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="userInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." />
      <button onclick="sendMessage()">Send</button>
    </div>
    <div class="controls">
      <button onclick="viewer.animate({ interval: 100 })">â–¶ ì¬ìƒ</button>
      <button onclick="viewer.stopAnimate()">â¸ ì •ì§€</button>
    </div>
  </div>
</div>

<script src="https://3Dmol.org/build/3Dmol-min.js"></script>

<script>
let viewer;

fetch("{% static 'traj/oxidation_final.xyz' %}")
  .then(res => res.text())
  .then(data => {
    viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
    viewer.addModelsAsFrames(data, "xyz");
    viewer.setStyle({}, { sphere: {} });
    viewer.zoomTo();
    viewer.render();
    viewer.animate({ interval: 100 }); // ìë™ ì¬ìƒ ì‹œì‘
  });


function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function sendMessage() {
  const input = document.getElementById('userInput');
  const chatLog = document.getElementById('chatLog');
  const userMessage = input.value.trim();

  if (!userMessage) return;

  
  chatLog.innerHTML += `<div><strong>ë‚˜:</strong> ${userMessage}</div>`;
  chatLog.scrollTop = chatLog.scrollHeight;

  const loading = document.createElement('div');
  loading.innerHTML = `<strong>GPT:</strong> ...ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...`;
  chatLog.appendChild(loading);
  chatLog.scrollTop = chatLog.scrollHeight;

  fetch("/ai_chat/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ message: userMessage })
  })
  .then(res => res.json())
  .then(data => {
    loading.innerHTML = `<strong>GPT:</strong> ${data.reply}`;
    chatLog.scrollTop = chatLog.scrollHeight;
  });

  input.value = '';
}
</script>
